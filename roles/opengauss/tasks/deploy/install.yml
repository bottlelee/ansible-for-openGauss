- name: "Create local file {{ inventory_dir + 'cluster_config.xml' }}"
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ inventory_dir }}/cluster_config.xml"
    owner: "{{ og_user }}"
    group: "{{ og_group }}"
    mode: "0644"
    lstrip_blocks: true
  with_first_found:
    - "{{ inventory_dir }}/templates/cluster_config.xml.j2"
    - "cluster_config.xml.j2"
  delegate_to: localhost
  become: false

- name: "Upload cluster_config.xml to {{ og_upload_path + '/cluster_config.xml' }}"
  ansible.builtin.copy:
    src: "{{ inventory_dir }}/cluster_config.xml"
    dest: "{{ og_upload_path }}/"
    owner: "{{ og_user }}"
    group: "{{ og_group }}"
    mode: "0644"
    backup: true

# 预部署脚本
- name: "Run {{ og_upload_path + '/script/gs_preinstall' }}"
  ansible.builtin.command: >-
    {{ og_upload_path }}/script/gs_preinstall \
      -U {{ og_user }} \
      -G {{ og_group }} \
      -X {{ og_upload_path }}/cluster_config.xml \
      --non-interactive
  changed_when: false

# 某些情况下，无法直接从单节点扩容到 1 主 1 备 1 级联。
# 怀疑是因为需要先有备机才能再有级联，回头仔细再看看官方文档。
# 奇怪的是我之前有成功过，所以也可能我哪儿改错了代码。
# 暂时先这样了，先扩容备机，再扩容级联机，耗时相应地增加了:(

# 从扩容列表里拆分出备机和级联机
# - name: "Set 'standby_nodes' and 'cascade_nodes'"
#   ansible.builtin.set_fact:
#     standby_nodes: >-
#       {%- for node in ep_nodes if node in groups['opengauss_standby'] -%}
#         {{ node }}{{ (loop.nextitem is defined) | ternary(',', '') }}
#       {%- endfor -%}
#     cascade_nodes: >-
#       {%- for node in ep_nodes if node in groups['opengauss_cascade'] -%}
#         {{ node }}{{ (loop.nextitem is defined) | ternary(',', '') }}
#       {%- endfor -%}

# 备机扩容
- name: Start expansion
  become_user: root
  when:
    - "og_expansion"
    # - "standby_nodes is truthy"
  block:
    - name: Expanding standby nodes
      ansible.builtin.shell: >-
        . /home/{{ og_user }}/.bashrc && \
          {{ og_upload_path }}/script/gs_expansion \
            -U {{ og_user }} \
            -G {{ og_group }} \
            -X {{ og_upload_path }}/cluster_config.xml \
            --time-out {{ (ep_nodes | count) * 600 }} \
            -h {{ ep_nodes | join(',') }}
      changed_when: false

    - name: Import 'wait_for_started' tasks
      ansible.builtin.import_tasks:
        file: wait_for_started.yml

# # 级联机扩容，前提是有备机节点。
# - name: Start cascade expansion
#   become_user: root
#   when:
#     - "og_expansion"
#     - "cascade_nodes is truthy"
#     - "groups['opengauss_standby'] is truthy"
#   block:
#     - name: Expanding cascade nodes
#       ansible.builtin.shell: >-
#         . /home/{{ og_user }}/.bashrc && \
#           {{ og_upload_path }}/script/gs_expansion \
#             -U {{ og_user }} \
#             -G {{ og_group }} \
#             -X {{ og_upload_path }}/cluster_config.xml \
#             --time-out {{ (ep_nodes | count) * 600 }} \
#             -h {{ cascade_nodes }}
#       changed_when: false

#     - name: Import 'wait_for_started' tasks
#       ansible.builtin.import_tasks:
#         file: wait_for_started.yml

# 初次部署
- name: "Run {{ og_upload_path + '/script/gs_install' }}"
  ansible.builtin.command: >-
    gs_install \
      -X {{ og_upload_path }}/cluster_config.xml \
      --gsinit-parameter="--pwpasswd={{ og_db_pass }}" \
      --gsinit-parameter="--locale={{ og_locale }}" \
      --time-out {{ (og_all_nodes | count) * 600 }}
  changed_when: false
  become_user: "{{ og_user }}"
  become_flags: "-i"
  when: "not og_expansion"
